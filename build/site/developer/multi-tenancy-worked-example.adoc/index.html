<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Multi Tenancy in Neo4j: A Worked Example :: Neo4j Developer Portal</title>
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article developer">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/developer">
        <svg width="97px" height="36px" viewBox="0 0 97 36" class="logo">
          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g transform="translate(0.000000, 1.000000)" fill-rule="nonzero">
              <g>
                <path
                  d="M28.7331787,15.4086598 C28.7331787,23.4004124 22.3016241,29.8779381 14.3665893,29.8779381 C6.43155452,29.8779381 0,23.4004124 0,15.4086598 C0,7.41690722 6.43155452,0.939375765 14.3665893,0.939375765 C22.3016241,0.932371134 28.7331787,7.41690722 28.7331787,15.4086598"
                  fill="#008CC1"></path>
                <path
                  d="M6.36890951,10.6626804 C6.36890951,11.3006186 5.85382831,11.8193814 5.22041763,11.8193814 C4.58700696,11.8193814 4.07192575,11.3006186 4.07192575,10.6626804 C4.07192575,10.0247423 4.58700696,9.50597938 5.22041763,9.50597938 C5.86078886,9.50597938 6.36890951,10.0247423 6.36890951,10.6626804"
                  fill="#FFFFFF"></path>
                <path
                  d="M6.5638051,13.8383505 C6.5638051,14.4762887 6.0487239,14.9950515 5.41531323,14.9950515 C4.78190255,14.9950515 4.26682135,14.4762887 4.26682135,13.8383505 C4.26682135,13.2004124 4.78190255,12.6816495 5.41531323,12.6816495 C6.0487239,12.6816495 6.5638051,13.1934021 6.5638051,13.8383505"
                  fill="#FFFFFF"></path>
                <path
                  d="M7.26682135,17.203299 C7.26682135,17.8412371 6.75174014,18.36 6.11832947,18.36 C5.48491879,18.36 4.96983759,17.8412371 4.96983759,17.203299 C4.96983759,16.5653608 5.48491879,16.0465979 6.11832947,16.0465979 C6.75174014,16.0395876 7.26682135,16.5583505 7.26682135,17.203299"
                  fill="#FFFFFF"></path>
                <path
                  d="M8.83990719,20.217732 C8.83990719,20.8556701 8.32482599,21.374433 7.69141531,21.374433 C7.05800464,21.374433 6.54292343,20.8556701 6.54292343,20.217732 C6.54292343,19.5797938 7.05800464,19.0610309 7.69141531,19.0610309 C8.32482599,19.0540206 8.83990719,19.5727835 8.83990719,20.217732"
                  fill="#FFFFFF"></path>
                <path
                  d="M21.1392111,24.4309278 C21.1392111,25.068866 20.6241299,25.5876289 19.9907193,25.5876289 C19.3573086,25.5876289 18.8422274,25.068866 18.8422274,24.4309278 C18.8422274,23.7929897 19.3573086,23.2742268 19.9907193,23.2742268 C20.6241299,23.2742268 21.1392111,23.7929897 21.1392111,24.4309278"
                  fill="#FFFFFF"></path>
                <path
                  d="M23.2273782,21.942268 C23.2273782,22.5802062 22.712297,23.0989691 22.0788863,23.0989691 C21.4454756,23.0989691 20.9303944,22.5802062 20.9303944,21.942268 C20.9303944,21.3043299 21.4454756,20.785567 22.0788863,20.785567 C22.712297,20.785567 23.2273782,21.3043299 23.2273782,21.942268"
                  fill="#FFFFFF"></path>
                <path
                  d="M17.1716937,4.34639175 C17.1716937,4.9843299 16.6566125,5.50309278 16.0232019,5.50309278 C15.3897912,5.50309278 14.87471,4.9843299 14.87471,4.34639175 C14.87471,3.70845361 15.3897912,3.18969072 16.0232019,3.18969072 C16.6566125,3.18969072 17.1716937,3.70845361 17.1716937,4.34639175"
                  fill="#FFFFFF"></path>
                <path
                  d="M14.1508121,3.28082474 C14.1508121,3.91876289 13.6357309,4.43752577 13.0023202,4.43752577 C12.3689095,4.43752577 11.8538283,3.91876289 11.8538283,3.28082474 C11.8538283,2.6428866 12.3689095,2.12412371 13.0023202,2.12412371 C13.6357309,2.12412371 14.1508121,2.6428866 14.1508121,3.28082474"
                  fill="#FFFFFF"></path>
                <ellipse id="Oval" stroke="#FFFFFF" fill="#66B245" cx="22.2946636" cy="11.9595876" rx="7.65661253"
                  ry="7.71134021"></ellipse>
                <ellipse id="Oval" stroke="#FFFFFF" fill="#66B245" cx="11.8051044" cy="27.6837113" rx="6.26450116"
                  ry="6.30927835"></ellipse>
                <ellipse id="Oval" stroke="#FFFFFF" fill="#66B245" cx="6.64733179" cy="4.20618557" rx="4.17633411"
                  ry="4.20618557"></ellipse>
              </g>
              <g id="neo4j" transform="translate(33.000000, 1.000000)" fill="#000000">
                <path
                  d="M0,4.87252125 L1.39130435,4.87252125 L1.39130435,7.6203966 C2.05913043,5.9490085 3.45043478,4.64589235 6.28869565,4.64589235 C9.51652174,4.64589235 11.6869565,6.85552408 11.6869565,10.3399433 L11.6869565,19.1501416 L10.2956522,19.1501416 L10.2956522,10.6232295 C10.2956522,7.76203966 8.57043478,5.97733711 5.9826087,5.97733711 C3.17217391,5.97733711 1.39130435,8.18696884 1.39130435,11.4730878 L1.39130435,19.1501416 L0,19.1501416 L0,4.87252125 Z">
                </path>
                <path
                  d="M14.1634783,12.0396601 C14.1634783,7.59206799 17.1408696,4.5325779 21.0086957,4.5325779 C24.8208696,4.5325779 27.52,7.73371105 27.52,11.6430595 C27.52,11.6430595 27.52,12.0679887 27.4921739,12.3512748 L15.5269565,12.3512748 C15.6104348,15.7790368 17.8643478,18.2152975 21.0643478,18.2152975 C23.68,18.2152975 25.4886957,17.082153 26.3234783,16.0056657 L26.3234783,17.6770538 C25.0156522,18.8668555 23.4295652,19.5467422 21.0643478,19.5467422 C17.0295652,19.5467422 14.1634783,16.5439093 14.1634783,12.1246459 L14.1634783,12.0396601 Z M26.0452174,11.0764873 C26.0173913,8.15864023 23.7913043,5.86402266 21.0086957,5.86402266 C18.0869565,5.86402266 15.693913,8.15864023 15.5826087,11.0764873 L26.0452174,11.0764873 Z">
                </path>
                <path
                  d="M37.0643478,4.50424929 C41.1826087,4.50424929 44.4382609,7.70538244 44.4382609,12.0113314 C44.4382609,16.3172805 41.1826087,19.5184136 37.0643478,19.5184136 C32.946087,19.5184136 29.6904348,16.3172805 29.6904348,12.0113314 C29.6904348,7.70538244 32.946087,4.50424929 37.0643478,4.50424929 Z M37.0643478,18.1869688 C40.4869565,18.1869688 43.0469565,15.5240793 43.0469565,12.0113314 C43.0469565,8.49858357 40.4869565,5.83569405 37.0643478,5.83569405 C33.6417391,5.83569405 31.0817391,8.49858357 31.0817391,12.0113314 C31.0817391,15.5240793 33.6417391,18.1869688 37.0643478,18.1869688 Z">
                </path>
                <polygon
                  points="51.7843478 4.87252125 53.3426087 4.87252125 47.3878261 17.7903683 56.0417391 17.7903683 56.0417391 13.1161473 57.4886957 13.1161473 57.4886957 24.6175637 56.0417391 24.6175637 56.0417391 19.1501416 45.1895652 19.1501416">
                </polygon>
                <path
                  d="M62.2469565,4.87252125 L63.6382609,4.87252125 L63.6382609,21.1331445 C63.6382609,24.3342776 61.8295652,24.9858357 60.0765217,24.9858357 C59.7426087,24.9858357 59.3808696,24.9575071 59.1582609,24.9008499 L59.1582609,23.5694051 C59.4921739,23.6260623 59.8817391,23.6543909 60.2156522,23.6543909 C61.6347826,23.6543909 62.2469565,22.9461756 62.2469565,21.1331445 L62.2469565,4.87252125 Z M61.9408696,1.04815864 C61.9408696,0.45325779 62.413913,0.0283286119 62.9426087,0.0283286119 C63.4713043,0.0283286119 63.9443478,0.45325779 63.9443478,1.04815864 C63.9443478,1.61473088 63.4713043,2.03966006 62.9426087,2.03966006 C62.413913,2.03966006 61.9408696,1.61473088 61.9408696,1.04815864 Z">
                </path>
              </g>
            </g>
          </g>
        </svg>

        <svg width="131px" height="34px" viewBox="0 0 131 34">
          <path
            d="M11.112,20.364 C13.996,20.364 16.124,18.768 16.712,17.06 L16.712,20 L18.112,20 L18.112,0.484 L16.712,0.484 L16.712,8.828 C16.124,7.12 13.996,5.524 11.112,5.524 C7.164,5.524 4,8.688 4,12.944 C4,17.2 7.136,20.364 11.112,20.364 Z M11.112,19.048 C7.864,19.048 5.4,16.416 5.4,12.944 C5.4,9.5 7.864,6.84 11.112,6.84 C14.388,6.84 16.88,9.388 16.88,12.944 C16.88,16.5 14.388,19.048 11.112,19.048 Z M26.876,20.336 C28.864,20.336 30.824,19.692 32.42,17.872 L31.496,16.976 C30.292,18.236 28.92,19.02 26.876,19.02 C23.656,19.02 21.388,16.668 21.304,13.28 L33.344,13.28 C33.372,13 33.372,12.58 33.372,12.58 C33.372,8.688 30.656,5.524 26.82,5.524 C22.928,5.524 19.932,8.576 19.932,12.972 L19.932,13.056 C19.932,17.368 22.844,20.336 26.876,20.336 Z M31.916,12.02 L21.36,12.02 C21.472,9.108 23.852,6.84 26.82,6.84 C29.648,6.84 31.888,9.136 31.916,12.02 Z M40.624,20.728 L47.204,5.888 L45.692,5.888 L40.624,17.452 L35.612,5.888 L34.1,5.888 L40.624,20.728 Z M54.904,20.336 C56.892,20.336 58.852,19.692 60.448,17.872 L59.524,16.976 C58.32,18.236 56.948,19.02 54.904,19.02 C51.684,19.02 49.416,16.668 49.332,13.28 L61.372,13.28 C61.4,13 61.4,12.58 61.4,12.58 C61.4,8.688 58.684,5.524 54.848,5.524 C50.956,5.524 47.96,8.576 47.96,12.972 L47.96,13.056 C47.96,17.368 50.872,20.336 54.904,20.336 Z M59.944,12.02 L49.388,12.02 C49.5,9.108 51.88,6.84 54.848,6.84 C57.676,6.84 59.916,9.136 59.944,12.02 Z M67.672,20.364 C68.092,20.364 68.484,20.308 68.848,20.224 L68.848,18.936 C68.484,19.02 68.092,19.048 67.672,19.048 C66.188,19.048 65.572,18.208 65.572,16.36 L65.572,0.484 L64.172,0.484 L64.172,16.444 C64.172,19.692 65.964,20.364 67.672,20.364 Z M77.22,20.364 C81.364,20.364 84.64,17.2 84.64,12.944 C84.64,8.688 81.364,5.524 77.22,5.524 C73.076,5.524 69.8,8.688 69.8,12.944 C69.8,17.2 73.076,20.364 77.22,20.364 Z M77.22,19.048 C73.776,19.048 71.2,16.416 71.2,12.944 C71.2,9.472 73.776,6.84 77.22,6.84 C80.664,6.84 83.24,9.472 83.24,12.944 C83.24,16.416 80.664,19.048 77.22,19.048 Z M88.812,25.404 L88.812,17.06 C89.4,18.768 91.528,20.364 94.412,20.364 C98.36,20.364 101.524,17.2 101.524,12.944 C101.524,8.688 98.388,5.524 94.412,5.524 C91.528,5.524 89.4,7.12 88.812,8.828 L88.812,5.888 L87.412,5.888 L87.412,25.404 L88.812,25.404 Z M94.412,19.048 C91.136,19.048 88.644,16.5 88.644,12.944 C88.644,9.388 91.136,6.84 94.412,6.84 C97.66,6.84 100.124,9.472 100.124,12.944 C100.124,16.388 97.66,19.048 94.412,19.048 Z M110.652,20.336 C112.64,20.336 114.6,19.692 116.196,17.872 L115.272,16.976 C114.068,18.236 112.696,19.02 110.652,19.02 C107.432,19.02 105.164,16.668 105.08,13.28 L117.12,13.28 C117.148,13 117.148,12.58 117.148,12.58 C117.148,8.688 114.432,5.524 110.596,5.524 C106.704,5.524 103.708,8.576 103.708,12.972 L103.708,13.056 C103.708,17.368 106.62,20.336 110.652,20.336 Z M115.692,12.02 L105.136,12.02 C105.248,9.108 107.628,6.84 110.596,6.84 C113.424,6.84 115.664,9.136 115.692,12.02 Z M121.292,20 L121.292,12.272 C121.292,9.472 122.776,7.092 125.856,7.092 C126.192,7.092 126.584,7.12 126.752,7.148 L126.752,5.692 C126.556,5.664 126.276,5.664 126.08,5.664 C123.308,5.664 121.88,7.008 121.292,8.716 L121.292,5.888 L119.892,5.888 L119.892,20 L121.292,20 Z"
            id="developer"></path>
        </svg>
              </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <div class="navbar-item is-hoverable developer">
          <a class="navbar-link" href="/developer">Developer Guides</a>
        </div>
        <div class="navbar-item has-dropdown is-hoverable docs">
          <a class="navbar-link" href="/docs">Docs</a>
          <div class="navbar-dropdown">
            <div class="navbar-item project" href="">
              <a class="project-name" href="">Operations Manual</a>

              <ul class="project-links">
                <li><a href="" class="project-link">Migration Guide</a></li>
                <li><a href="" class="project-link">Status Codes</a></li>
              </ul>
            </div>
            <div class="navbar-item project" href="">
              <a class="project-name" href="">Cypher Manual</a>

              <ul class="project-links">
                <li><a href="" class="project-link">Cyper Refcard</a></li>
              </ul>
            </div>
            <div class="navbar-item project" href="">
              <a class="project-name" href="">Driver Manual</a>

              <ul class="project-links">
                <li><a href="" class="project-link">Java</a></li>
                <li><a href="" class="project-link">JavaScript</a></li>
                <li><a href="" class="project-link">.NET</a></li>
                <li><a href="" class="project-link">Python</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable labs">
          <a class="navbar-link" href="/labs">Labs</a>
          <div class="navbar-dropdown">
            <div class="navbar-item project">
              <a class="project-name" href="/labs/apoc">APOC</a>
              <p class="project-description">A library of procedures and functions for interacting with Neo4j</p>

              <ul class="project-links">
                <li><a href="/labs/apoc/4.0" class="project-link">Documentation</a></li>
                <li><a href="/labs/apoc/" class="project-link">Developer Guide</a></li>
              </ul>
            </div>
            <div class="navbar-item project">
              <a class="project-name" href="/labs/streams">Neo4j Streams</a>
              <p class="project-description">Integration for Neo4j &amp; Kafka</p>

              <ul class="project-links">
                <li><a href="/labs/streams/4.0" class="project-link">Documentation</a></li>
                <li><a href="/labs/streams" class="project-link">Developer Guide</a></li>
              </ul>
            </div>
            <div class="navbar-item project">
              <a class="project-name" href="/labs/neosemantics">neosemantics</a>
              <p class="project-description">An RDF Toolkit for Neo4j</p>

              <ul class="project-links">
                <li><a href="/labs/neosemantics/4.0" class="project-link">Documentation</a></li>
                <li><a href="/labs/neosemantics" class="project-link">Developer Guide</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="navbar-item">
          <a class="navbar-link" href="/search" id="search_open"><svg width="23px" height="23px" viewBox="0 0 23 23" version="1.1" xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink" class="fill-current float-right" id="search" role="button"
              title="Search Website">
              <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round"
                stroke-linejoin="round">
                <g transform="translate(-2.000000, -2.000000)" stroke="#a0aec0" stroke-width="1.5">
                  <circle id="Oval"
                    transform="translate(11.389364, 11.388564) rotate(-23.025000) translate(-11.389364, -11.388564) "
                    cx="11.3893642" cy="11.3885639" r="8.056"></circle>
                  <path d="M17.0853333,17.0844444 L23.3333333,23.3333333" id="Shape"></path>
                </g>
              </g>
            </svg><span class="navbar-mobile">Search</span></a>
        </div>
      </div>
    </div>
  </nav>
</header><div class="search" id="search">
    <div class="search-container">
        <form class="search-form">
            <label for="search_input">Search Neo4j.com</label>

            <input id="search_input" type="text" name="search"
                placeholder="Try &quot;MATCH clause&quot; or &quot;Monitoring Queries&quot;">
            <div class="search-icon">
                <svg width="16px" height="22px" viewBox="0 0 23 23" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink" class="fill-current float-right" id="submit_search"
                    role="button" title="Search Website">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round"
                        stroke-linejoin="round">
                        <g transform="translate(-2.000000, -2.000000)" stroke="#a0aec0" stroke-width="1.5">
                            <circle id="Oval"
                                transform="translate(11.389364, 11.388564) rotate(-23.025000) translate(-11.389364, -11.388564) "
                                cx="11.3893642" cy="11.3885639" r="8.056"></circle>
                            <path d="M17.0853333,17.0844444 L23.3333333,23.3333333" id="Shape"></path>
                        </g>
                    </g>
                </svg>
            </div>
            <div class="search-icon">
                <svg width="14px" height="22px" viewBox="0 0 22 22" role="button" class="cancel" id="close_search">
                    <line x1="19.5833333" y1="0.416666667" x2="0.416666667" y2="19.5833333"></line>
                    <line x1="19.5833333" y1="19.5833333" x2="0.416666667" y2="0.416666667"></line>
                </svg>
            </div>
        </form>
        <div class="search-results"></div>

        <div class="search-filters hidden">
            <div class="search-filters-header">
                <h2>Filter By Category</h2>
                <div class="search-filters-icon">
                    <svg width="14px" height="22px" viewBox="0 0 22 22" role="button" class="cancel" id="close_filters">
                        <line x1="19.5833333" y1="0.416666667" x2="0.416666667" y2="19.5833333"></line>
                        <line x1="19.5833333" y1="19.5833333" x2="0.416666667" y2="0.416666667"></line>
                    </svg>
                </div>
            </div>

            <div class="search-filters-content">
            </div>
        </div>

    </div>
</div><div class="body">
<div class="nav-container" data-component="developer" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../">Developer Guides</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#get-started.adoc">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-database.adoc">What is a Graph Database?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#intro-videos.adoc">Intro to Graph DBs Video Series</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-db-vs-rdbms.adoc">Concepts: RDBMS to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-db-vs-nosql.adoc">Concepts: NoSQL to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#getting-started-resources.adoc">Getting Started Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Graph Platform</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-platform.adoc">Graph Platform Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-desktop.adoc">Neo4j Desktop Intro</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-browser.adoc">Neo4j Browser Intro</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-bloom.adoc">Neo4j Bloom Intro</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-etl.adoc">How-To: Neo4j ETL Tool</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-apoc.adoc">Neo4j APOC Library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-algorithms.adoc">Neo4j Graph Algorithms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graphql.adoc">Neo4j &amp; GraphQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-nlp.adoc">Neo4j Natural Language Processing (NLP)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Cypher Query Language</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cypher-query-language.adoc">Cypher Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cypher-basics-i.adoc">Cypher Basics I</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cypher-basics-ii.adoc">Cypher Basics II</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#filtering-query-results.adoc">Filtering Query Results</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#sub-queries.adoc">Sub Queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aggregation-returns-functions.adoc">Aggregation, Returns, &amp; Functions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cypher-style-guide.adoc">Cypher Style Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-sql-to-cypher.adoc">From SQL to Cypher</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#procedures-functions.adoc">User Defined Procedures &amp; Functions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#dates-datetimes-durations.adoc">Tutorial: Dates, Datetimes, and Durations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-build-a-recommendation-engine.adoc">Tutorial: Build a Recommendation Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cypher-resources.adoc">Cypher Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Graph Data Modeling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#data-modeling.adoc">Graph Modeling Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-data-modeling.adoc">Graph Modeling Guidelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#relational-to-graph-modeling.adoc">Modeling: RDBMS to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#modeling-designs.adoc">Modeling Designs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#modeling-tips.adoc">Graph Modeling Tips</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-model-refactoring.adoc">Tutorial: Refactoring a graph model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graphgist.adoc">Interactive Graph Models</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Data Import</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#data-import.adoc">Import Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-import-csv.adoc">Importing CSV</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-import-json-rest-api.adoc">Importing API Data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#relational-to-graph-import.adoc">Import: RDBMS to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-importing-data-and-etl.adoc">Example: Northwind Dataset</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#desktop-csv-import.adoc">How-To: Desktop CSV Import</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#example-data.adoc">Example Datasets</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Graph Visualization</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-visualization.adoc">Visualization Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tools-graph-visualization.adoc">Visualization Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#other-graph-visualizations.adoc">Other Visualizations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Drivers &amp; Language Guides</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#language-guides.adoc">Drivers Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#java.adoc">Java</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#java-driver-spring-boot-starter.adoc">Java Driver Spring Boot Starter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-ogm.adoc">Neo4j Object Graph Mapper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#spring-data-neo4j.adoc">Spring Data Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#spring-data-neo4j-rx.adoc">Spring Data Neo4j RX</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#java-procedures.adoc">Procedures and Functions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#java-third-party.adoc">Third-party libraries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#dotnet.adoc">.NET</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#javascript.adoc">JavaScript</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#python.adoc">Python</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#go.adoc">Go</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ruby.adoc">Ruby</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#php.adoc">PHP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#erlang-elixir.adoc">Erlang &amp; Elixir</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#perl.adoc">Perl</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Tools &amp; Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#integration.adoc">Integrations Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#apache-spark.adoc">Apache Spark</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#elastic-search.adoc">Elastic-Search</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#mongodb.adoc">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cassandra.adoc">Cassandra</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Aura DBaaS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-cloud-dbaas.adoc">Aura DBaaS Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-connect-neo4j-desktop.adoc">Connect from Neo4j Desktop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-connect-cypher-shell.adoc">Connect from Cypher Shell</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-connect-driver.adoc">Connect from your application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-data-import.adoc">Data Import with Neo4j Aura</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-grandstack.adoc">Deploying a GRANDstack application to Aura</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-bloom.adoc">Bloom Visualization with Aura</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#aura-monitoring.adoc">Monitoring</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Graph Apps</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-apps.adoc">Graph Apps Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#graph-app-development.adoc">Building Graph Apps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#in-production.adoc">Administration Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#manage-multiple-databases.adoc">Tutorial: Managing Multiple Databases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#multi-tenancy-worked-example.adoc">Tutorial: Multi Tenancy Worked Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#neo4j-fabric-sharding.adoc">Sharding Graphs with Fabric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-clustering-neo4j.adoc">Clustering Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-performance-tuning.adoc">Performance Tuning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docker.adoc">Docker &amp; Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docker-run-neo4j.adoc">How-To: Run Neo4j in Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="/startup-program/">Startups: Free Neo4j Enterprise</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="/graphacademy/online-training/neo4j-administration/">Online Course: Neo4j Administration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j in the Cloud</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-cloud-deployment.adoc">Cloud Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-orchestration.adoc">Orchestration Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Documentation &amp; Resources</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#resources.adoc">Resource Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#about-graphacademy.adoc">Learn through GraphAcademy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#guide-create-neo4j-browser-guide.adoc">Tutorial: Create Custom Browser Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#ruby-course.adoc">How-To: Build with Ruby &amp; Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#browser-guide-list.adoc">Available Neo4j Browser Guides</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="/docs/">Neo4j Documentation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Contributing to Neo4j</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#contribute.adoc">Contributing Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cla.adoc">Contributor License Agreement</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#contributing-code.adoc">Code Contributions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://community.neo4j.com">Help on Community Forums</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="/speaker-program/">Speaker Program: Share your Story</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../">Developer Guides</a></li>
    <li><a href="./">Multi Tenancy in Neo4j: A Worked Example</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/adam/projects/docs/asciidoc/developer/modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Multi Tenancy in Neo4j: A Worked Example</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<div class="title">Goals</div>
<blockquote>
In this guide, we will learn how to do multi tenancy in Neo4j.
</blockquote>
</div>
<div class="quoteblock abstract">
<div class="title">Prerequisites</div>
<blockquote>
Please have <a href="/download" target="_blank" rel="noopener">Neo4j</a> (version 4.0 or later) downloaded and installed.
It helps to have read the section on <a href="/developer/in-production/manage-multiple-databases/">managing multiple databases</a>.
We&#8217;ll also need to install <a href="https://neo4j.com/developer/neo4j-apoc/" target="_blank" rel="noopener">APOC</a>, Neo4j&#8217;s standard library.
</blockquote>
</div>
<div class="paragraph expertise">
<p>{level}</p>
</div>
<div id="multi-tenancy" class="paragraph">
<p>In Neo4j (v4.0+), we can create and use more than one active database at the same time.
This works in standalone and causal cluster scenarios and allows us to maintain multiple, separate graphs in one installation.</p>
</div>
<div class="paragraph">
<p>In this guide we&#8217;re going to learn how to use this feature with a multi tenant dataset.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup-db"><a class="anchor" href="#setup-db"></a>System setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you haven&#8217;t already, <a href="/download/" target="_blank" rel="noopener">download</a> Neo4j.</p>
</div>
<div class="paragraph">
<p>We will need to have a database running and open <a href="/developer/neo4j-browser/">Neo4j Browser</a> to walk through this guide.
If you are unsure how to create and start a database, step-by-step instructions for doing so in Neo4j Desktop are provided in <a href="/developer/neo4j-desktop">this guide</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;re going to use the APOC Library in this guide, and in order to process local files, we&#8217;ll need need to add the following entry to the <code>apoc.conf</code> file:</p>
</div>
<div class="listingblock">
<div class="title">apoc.conf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">apoc.import.file.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll also be using <a href="https://neo4j.com/docs/operations-manual/current/fabric/introduction/" target="_blank" rel="noopener">Neo4j Fabric</a>, which we can enable by adding the following properties in the <code>neo4j.conf</code> file:</p>
</div>
<div class="listingblock">
<div class="title">neo4j.conf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">fabric.database.name=fabric

fabric.graph.0.name=mall1
fabric.graph.0.uri=neo4j://localhost:7687
fabric.graph.0.database=mall1

fabric.graph.1.name=mall2
fabric.graph.1.uri=neo4j://localhost:7687
fabric.graph.1.database=mall2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="carrefour-retail-dataset"><a class="anchor" href="#carrefour-retail-dataset"></a>Carrefour Retail dataset</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to use a dataset published by Carrefour, a French retailer, as part of their <a href="https://github.com/ging/carrefour_basket_data_challenge" target="_blank" rel="noopener">Delighting Customers Challenge Basket Data</a>.
Rik van Bruggen recently wrote a series of blog posts showing how to import and analyse this data in Neo4j 3.5.</p>
</div>
<div class="paragraph">
<p>The data is available as <a href="https://drive.google.com/a/neotechnology.com/uc?id=1wDNAMFk_3-H1l44ID4P6fcE6K7cvG9iX&amp;export=download" target="_blank" rel="noopener">a JSON file</a> curated by Rik.
Once we&#8217;ve downloaded the file, we need to put it into the <code>import</code> folder of Neo4j.</p>
</div>
<div class="paragraph">
<p>The dataset is accompanied by a data dictionary that describes each of the fields that we see in the file:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Data Dictionary</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number id for that individual ticket.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mall</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store where the ticket was printed. It has two values, 1 and 2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date and time the ticket was printed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some tickets will have a Customer ID. Many tickets will share a Customer ID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of items contained in the printed ticket. The list contains a dictionary with a product description (desc), the amount charged (net_am), and the number of units bought (n_unit).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>From looking at these descriptions, <code>mall</code> seems like a good property to use to partition the data.
We can store the tickets printed in mall 1 in one database, and the tickets printed in mall 2 in another database.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exploring-data"><a class="anchor" href="#exploring-data"></a>Exploring the data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can now process this file using the <code>apoc.load.json</code> procedure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CALL apoc.load.json("file:///DelightingCustomersBDclean.json")
YIELD value
RETURN value
LIMIT 5;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{date: "2016-01-14T20:07:00.000+0000", client: 77021708271, _id: 1001, items: [{n_unit: 1, net_am: 1.0, desc: "CARAMELOS S/AZUCAR"}], mall: 2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{date: "2016-01-14T15:25:00.000+0000", client: 77021708271, _id: 1002, items: [{n_unit: 1, net_am: 3.0, desc: "TOSTA VARIADA"}, {n_unit: 1, net_am: 1.0, desc: "BAGUETTE TORTILLA"}], mall: 1}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{date: "2016-01-14T20:07:00.000+0000", client: 77021708271, _id: 1003, items: [{n_unit: 1, net_am: 2.83, desc: "QUESO TIERNO MEZCL"}, {n_unit: 1, net_am: 1.65, desc: "GUISANTES MUY FINO"}, {n_unit: 1, net_am: 1.77, desc: "BIFIDUS CON FRUTAS"}, {n_unit: 1, net_am: 1.16, desc: "MAIZ DULCE PACK3X140"}, {n_unit: 1, net_am: 2.5, desc: "SANUS FRESA L. CASEI"}, {n_unit: 1, net_am: 1.0, desc: "FANTA LIMÓN S/BURB"}, {n_unit: 1, net_am: 1.85, desc: "CEREALES ESTRELLITAS"}, {n_unit: 1, net_am: 2.15, desc: "SALVASLIP EVAX"}, {n_unit: 1, net_am: 1.09, desc: "YOGUR NATURAL DANO"}, {n_unit: 1, net_am: 1.15, desc: "ARROZ LARGO SOS 1 KI"}, {n_unit: 1, net_am: 1.5, desc: "YORK SANDWICH ELPO"}, {n_unit: 1, net_am: 0.75, desc: "BARQUILLO NATA COVY"}, {n_unit: 1, net_am: 1.39, desc: "TRINA LIMON 1,5LITRO"}, {n_unit: 1, net_am: 1.85, desc: "CHORIZO DULCE CARR"}, {n_unit: 1, net_am: 1.0, desc: "PIMIENTO PIQUILLO"}, {n_unit: 24, net_am: 6.0, desc: "CERVEZA HOLANDESA"}, {n_unit: 1, net_am: 1.34, desc: "PECHUGA PAVO LONCH"}, {n_unit: 6, net_am: 1.52, desc: "AGUA CARREFOUR 2 L"}, {n_unit: 1, net_am: 1.69, desc: "FIAMBRE JAMON PAVO"}, {n_unit: 1, net_am: 0.66, desc: "BIFIDUS COCO 0%"}, {n_unit: 1, net_am: 2.74, desc: "DUPLO COLGATE TRIP"}], mall: 2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{date: "2016-01-14T16:25:00.000+0000", client: 77021708271, _id: 1004, items: [{n_unit: 1, net_am: 0.64, desc: "AGUA SOLAN CABRAS"}], mall: 2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">{date: "2016-01-14T14:25:00.000+0000", client: 77021708271, _id: 1005, items: [{n_unit: 1, net_am: 3.9, desc: "PAQUETE 500 HOJAS A4"}, {n_unit: 1, net_am: 4.99, desc: "LEGGING NINA 3/14"}, {n_unit: 1, net_am: 9.99, desc: "JERSEY UNISEX 3/14"}, {n_unit: 3, net_am: 4.6, desc: "HUESITOS LECHE 12"}, {n_unit: 1, net_am: 2.65, desc: "MINI FUET CAMPOFRIO"}, {n_unit: 2, net_am: 2.78, desc: "REGAÑA ACEITE OLIV"}, {n_unit: 1, net_am: 15.95, desc: "MEGA MAKI"}], mall: 1}</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We can see that some items are from mall 1 and some from mall 2.
Let&#8217;s have a look how many tickets each mall printed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CALL apoc.load.json("file:///DelightingCustomersBDclean.json")
YIELD value
RETURN value.mall, count(*)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Results</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">value.mall</th>
<th class="tableblock halign-left valign-top">count(*)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">293586</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">292893</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It looks like we&#8217;ll have two quite evenly populated databases.
Let&#8217;s get those databases created!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-databases"><a class="anchor" href="#creating-databases"></a>Creating databases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to store the data for each mall in a different Neo4j database.
We&#8217;ll create these databases using the <a href="https://neo4j.com/docs/cypher-manual/4.0/administration/databases/#administration-databases-create-database" target="_blank" rel="noopener"><code>CREATE DATABASE</code></a> command, which we need to run against the <code>system</code> database.
Let&#8217;s first switch to that database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">:use system;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we&#8217;ve done that we can run the following statements to create the databases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CREATE DATABASE mall1;
CREATE DATABASE mall2;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can check that those databases have been created by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">SHOW DATABASES;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. SHOW DATABASES</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">name</th>
<th class="tableblock halign-left valign-top">address</th>
<th class="tableblock halign-left valign-top">role</th>
<th class="tableblock halign-left valign-top">requestedStatus</th>
<th class="tableblock halign-left valign-top">currentStatus</th>
<th class="tableblock halign-left valign-top">error</th>
<th class="tableblock halign-left valign-top">default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"neo4j"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"0.0.0.0:7687"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"standalone"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"system"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"0.0.0.0:7687"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"standalone"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"fabric"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"0.0.0.0:7687"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"standalone"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mall1"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"0.0.0.0:7687"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"standalone"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"mall2"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"0.0.0.0:7687"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"standalone"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"online"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="graph-model"><a class="anchor" href="#graph-model"></a>Graph Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to import the data into the following graph model:</p>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/4dot0_multi_tenancy_graph_model.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/4dot0_multi_tenancy_graph_model.png" alt="4dot0 multi tenancy graph model"></a>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll have nodes representing products, clients, tickets, and ticket items, and relationships that indicate which client purchased a ticket, the items that comprise a ticket, and the product that each item was for.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="importing-data"><a class="anchor" href="#importing-data"></a>Importing the data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll use the same <code>apoc.load.json</code> procedure to import the data into each of our databases.
We&#8217;ll filter the JSON file by the <code>mall</code> property so that we load the data appropriately.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s switch to the <code>mall1</code> database and setup parameters that we&#8217;ll use in our import query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">:use mall1;
Unresolved include directive in modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc - include::importTickets.cypher[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we&#8217;ll create that indexes that we&#8217;re going to need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">Unresolved include directive in modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc - include::createConstraints.cypher[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re ready to process the JSON file.
We&#8217;ll wrap our call to <code>apoc.load.json</code> inside a call to <code>apoc.periodic.iterate</code> so that our import is batched, which will avoid out of memory exceptions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">Unresolved include directive in modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc - include::importTickets.cypher[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now let&#8217;s do the same thing for mall 2.
We&#8217;ll switch to that database and setup our parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">:use mall2;
Unresolved include directive in modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc - include::importTickets.cypher[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we&#8217;ll create that indexes that we&#8217;re going to need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">Unresolved include directive in modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc - include::createConstraints.cypher[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now let&#8217;s import the tickets sold in this store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">Unresolved include directive in modules/ROOT/pages/multi-tenancy-worked-example.adoc.adoc - include::importTickets.cypher[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see a sample of the imported graph in the Neo4j Browser visualization below:</p>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/4dot0_multi_tenancy_browser_viz.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/4dot0_multi_tenancy_browser_viz.png" alt="4dot0 multi tenancy browser viz"></a>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying-individual-databases"><a class="anchor" href="#querying-individual-databases"></a>Querying individual databases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve imported the data, let&#8217;s explore it by writing some queries.
We&#8217;ll show the results of running some queries on both databases and some just on one of them.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We can switch between the databases by running the command <code>:use mall1</code> or <code>:use mall2</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The following query returns the biggest spending clients in the mall:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH (client:Client)-[:PURCHASED]-&gt;(ticket)-[:HAS_TICKETITEM]-&gt;(item:TicketItem)
WHERE client.id &lt;&gt; "Unknown"
WITH client, count(DISTINCT ticket) AS tickets,
     apoc.math.round(sum(item.netAmount), 2) AS totalSpend
RETURN client.id AS clientId, totalSpend, tickets,
       apoc.math.round(totalSpend / tickets, 2) AS spendPerTicket
ORDER BY totalSpend DESC
LIMIT 10;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Mall 1 biggest spenders</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">clientId</th>
<th class="tableblock halign-left valign-top">totalSpend</th>
<th class="tableblock halign-left valign-top">tickets</th>
<th class="tableblock halign-left valign-top">spendPerTicket</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77038482725</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4125.71</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">95</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">43.43</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77091111583</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3111.06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">107.28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77042913479</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2726.84</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">51</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53.47</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77035560017</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2664.49</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">69</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">38.62</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77081132118</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2644.51</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80.14</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77060098914</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2433.68</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">101.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77071854908</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2379.27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">88.12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77079395996</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2272.06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">84.15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77042176706</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2183.27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">65</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33.59</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77059085165</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2162.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">49.14</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Mall 2 biggest spenders</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">clientId</th>
<th class="tableblock halign-left valign-top">totalSpend</th>
<th class="tableblock halign-left valign-top">tickets</th>
<th class="tableblock halign-left valign-top">spendPerTicket</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77038482725</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3314.19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">87</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">38.09</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77074230047</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3281.82</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">47</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">69.83</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77035560017</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3120.69</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">67</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">46.58</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77042573786</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2696.9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">87.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77017054434</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2572.42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57.16</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77091111583</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2494.08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">92.37</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77037711999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2369.63</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">65.82</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77053280208</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2359.28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40.68</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77045642784</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2337.03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53.11</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">77049483454</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2259.89</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40.36</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Interestingly, the biggest spending client in both malls is the same person.</p>
</div>
<div class="paragraph">
<p>The <code>spendPerTicket</code> also looks interesting.
The following query shows the products bought by the client that has the highest <code>spendPerTicket</code> in mall 2 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH path = (:Client {id: 77078849426})-[:PURCHASED]-&gt;()--&gt;(:TicketItem)--&gt;(:Product)
RETURN path</code></pre>
</div>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/4dot0_multi_tenancy_big_spender.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/4dot0_multi_tenancy_big_spender.png" alt="4dot0 multi tenancy big spender"></a>
</div>
<div class="title">Figure 1. A big spender in Mall 2</div>
</div>
<div class="paragraph">
<p>On the left hand side of the diagram we can see highlighted nodes that have skewed the average spend!
My Spanish isn&#8217;t great, but I can see an iPad Air among the items purchased.
<em>ASP ROB LG HOMB S5</em> is a <a href="https://www.carrefour.es/robot-aspirador-lg-lg-hombot-turbo-vr8602rr-smart-inverter-0-6-l-60-db-rojo/8806087897081" target="_blank" rel="noopener">robot vacuum cleaner</a> and I think <em>POR APP MB MJVE2YA</em> is an Apple Macbook.
The other items look more like the type of products you&#8217;d buy in a normal grocery shop.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to mall 1 and see which products are purchased most often.
We can write the following query to compute this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH (item:TicketItem)--&gt;(product:Product)
WITH product, apoc.math.round(sum(item.netAmount), 2) AS totalSpend,
     count(*) AS purchases
RETURN product.description, totalSpend, purchases,
       apoc.math.round(totalSpend / purchases, 2) AS costPerItem
ORDER BY totalSpend DESC
LIMIT 10;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Mall 1 popular products</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">product.description</th>
<th class="tableblock halign-left valign-top">totalSpend</th>
<th class="tableblock halign-left valign-top">purchases</th>
<th class="tableblock halign-left valign-top">costPerItem</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON NATA MEDIANO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4596.64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">450</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ACEITE OLIVA HOJIB"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3597.33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">269</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13.37</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU CLAS"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3328.62</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">363</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9.17</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU 5 *"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2870.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">383</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.49</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON MEDIANO SIN R"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2632.75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">363</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ATÚN CLARO ACEITE"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2404.49</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">502</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.79</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON DE REYES"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2363.89</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">158</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14.96</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ACEITE OLIVA CARBO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2268.72</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">180</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12.6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CAMISA CRO M/LARGA"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2208.31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">293</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.54</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"PAÑAL DODOT"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2186.34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">29.15</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All the top items are priced at less than 30 euros each.
We can see a couple of beers (cerveza) in positions 3 and 4, and then Roscon seems to be a range of <a href="https://www.carrefour.es/supermercado/roscon-de-reyes-con-nata-1-3-kg-carrefour/R-577901507" target="_blank" rel="noopener">tasty looking pastries</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying-across-databases"><a class="anchor" href="#querying-across-databases"></a>Querying across databases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can also write queries across databases using <a href="https://neo4j.com/docs/operations-manual/current/fabric/configuration/" target="_blank" rel="noopener">Neo4j Fabric</a>.
This functionality is useful for executing aggregate queries across multiple databases.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first change to the <em>fabric</em> database by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">:use fabric</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re going write a query that returns the total spend on products in each of our databases.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll prefix our queries with the <a href="https://neo4j.com/docs/cypher-manual/4.0/clauses/use/" target="_blank" rel="noopener"><code>USE</code></a> clause, which tells the Fabric engine which database to execute the query against.
The syntax of this clause is as follows:</p>
</div>
<div class="paragraph">
<p><code>USE &lt;fabric.database.name&gt;.&lt;fabric.graph.*.database&gt;</code></p>
</div>
<div class="paragraph">
<p>Or in our case <code>USE fabric.mall1</code> and <code>USE fabric.mall2</code>.</p>
</div>
<div class="paragraph">
<p>The following query finds the total spend and number of purchases in each mall, combines the results using the <a href="https://neo4j.com/docs/cypher-manual/4.0/clauses/union/#union-combine-queries-retain-duplicates" target="_blank" rel="noopener"><code>UNION ALL</code></a> clause, and then orders the results by total spend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">USE fabric.mall1
MATCH (item:TicketItem)--&gt;(product:Product)
RETURN "Mall 1" as mall,
       apoc.math.round(sum(item.netAmount), 2) AS totalSpend,
       count(*) AS purchases

UNION ALL

USE fabric.mall2
MATCH (item:TicketItem)--&gt;(product:Product)
RETURN "Mall 2" as mall,
       apoc.math.round(sum(item.netAmount), 2) AS totalSpend,
       count(*) AS purchases

ORDER BY totalSpend DESC;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Total spending in malls</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">mall</th>
<th class="tableblock halign-left valign-top">totalSpend</th>
<th class="tableblock halign-left valign-top">purchases</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mall 1"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">953536.51</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">219561</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Mall 2"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">943463.47</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">219966</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The total spend and number of purchases are almost identical between the malls!
We can also write a version of this query that reduces duplication by using the built-in <a href="https://neo4j.com/docs/operations-manual/current/fabric/queries/#fabric-built-in-functions" target="_blank" rel="noopener"><code>&lt;fabric-database-name&gt;graphIds</code></a> function and the <a href="https://neo4j.com/docs/cypher-manual/4.0/clauses/call-subquery/" target="_blank" rel="noopener"><code>CALL{}</code></a> clause, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">WITH ["Mall 1", "Mall 2"] AS malls
UNWIND fabric.graphIds() AS graphId
CALL {
  USE fabric.graph(graphId)
  MATCH (item:TicketItem)--&gt;(product:Product)
  RETURN apoc.math.round(sum(item.netAmount), 2) AS totalSpend,
         count(*) AS purchases
}
RETURN malls[graphId] AS mall, totalSpend, purchases
ORDER BY totalSpend DESC;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also aggregate the results returned by the sub queries executed on each of the mall databases.
The following query finds the highest selling products in each mall, and then shows the top 10 products across both malls:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">UNWIND fabric.graphIds() AS graphId
CALL {
  USE fabric.graph(graphId)
  MATCH (item:TicketItem)--&gt;(product:Product)
  WITH product, apoc.math.round(sum(item.netAmount), 2) AS totalSpend,
       count(*) AS purchases
  RETURN product, totalSpend, purchases
  ORDER BY totalSpend DESC
}
RETURN product.description, totalSpend, purchases
ORDER BY totalSpend DESC
LIMIT 10</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Top selling products across malls</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">product.description</th>
<th class="tableblock halign-left valign-top">totalSpend</th>
<th class="tableblock halign-left valign-top">purchases</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON NATA MEDIANO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4596.64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">450</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON NATA MEDIANO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4462.64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">451</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ACEITE OLIVA HOJIB"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3597.33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">269</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LED SAM UE48J6200"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3546.08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU CLAS"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3406.55</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">392</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU CLAS"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3328.62</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">363</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"PAÑAL DODOT"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3078.55</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">99</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU 5 *"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2870.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">383</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON MEDIANO SIN R"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2632.75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">363</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ACEITE OLIVA HOJIB"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2478.99</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">222</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The top selling product in both malls is <em>ROSCON NATA MEDIANO</em>, but it&#8217;d be good if the sales for each product was aggregated so that we have only one row per product.
We can do this using the <a href="https://neo4j.com/docs/cypher-manual/4.0/functions/aggregating/#functions-sum" target="_blank" rel="noopener"><code>SUM</code></a> aggregation function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">UNWIND fabric.graphIds() AS graphId
CALL {
  USE fabric.graph(graphId)
  MATCH (item:TicketItem)--&gt;(product:Product)
  WITH product, apoc.math.round(sum(item.netAmount), 2) AS totalSpend,
       count(*) AS purchases
  RETURN product, totalSpend, purchases
  ORDER BY totalSpend DESC
}
RETURN product.description, sum(totalSpend) AS totalSpend, sum(purchases) AS purchases
ORDER BY totalSpend DESC
LIMIT 10</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The implicit group by key for these aggregation functions is <code>product.description</code> and <strong>not</strong> <code>product</code>.
The product node is completely different in each of the databases, so if we grouped by that we&#8217;d still end up with individual per product sold in each mall.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The table below shows the results of running the aggregation query:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Top aggregated selling products across malls</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">product.description</th>
<th class="tableblock halign-left valign-top">totalSpend</th>
<th class="tableblock halign-left valign-top">purchases</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON NATA MEDIANO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9059.28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">901</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU CLAS"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6735.17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">755</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ACEITE OLIVA HOJIB"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6076.32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">491</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LED SAM UE48J6200"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5343.08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"PAÑAL DODOT"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5264.89</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">174</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CERVEZA MAHOU 5 *"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5236.620000000001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">740</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON MEDIANO SIN R"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4902.26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">689</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ROSCON DE REYES"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4783.57</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">318</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"ATÚN CLARO ACEITE"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4758.15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">974</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"CAMISA CRO M/LARGA"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4335.5599999999995</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">571</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="resources"><a class="anchor" href="#resources"></a>Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="/developer/manage-multiple-databases/" target="_blank" rel="noopener">Managing Multiple Databases in Neo4j</a></p>
</li>
<li>
<p><a href="/docs/operations-manual/current/manage-databases/" target="_blank" rel="noopener">Documentation: Multi-database</a></p>
</li>
<li>
<p><a href="https://adamcowley.co.uk/neo4j/multi-tenancy-neo4j-4.0/" target="_blank" rel="noopener">Multi-Tenancy in Neo4j 4.0</a></p>
</li>
<li>
<p><a href="https://adamcowley.co.uk/neo4j/sharding-neo4j-4.0/" target="_blank" rel="noopener">When and how to implement Sharding in Neo4j 4.0</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<div class="feedback">
    <div class="header question">
        <p><strong>Was this page helpful?</strong></p>

        <svg width="22px" height="22px" viewBox="0 0 22 22" role="button" class="no">
            <path
                d="M6.25,15.8333333 C6.25,13.7622655 7.92893219,12.0833333 10,12.0833333 C12.0710678,12.0833333 13.75,13.7622655 13.75,15.8333333"
                id="Shape"></path>
            <circle id="Oval" cx="10" cy="10" r="9.58333333"></circle>
            <path
                d="M12.5,4.58333333 C12.8934466,4.05873783 13.5109223,3.75 14.1666667,3.75 C14.822411,3.75 15.4398867,4.05873783 15.8333333,4.58333333"
                id="Shape"></path>
            <line x1="4.58333333" y1="7.91666667" x2="7.08333333" y2="7.91666667" id="Shape"></line>
            <path
                d="M7.08333333,8.54166667 C6.96827401,8.54166667 6.875,8.44839266 6.875,8.33333333 C6.875,8.21827401 6.96827401,8.125 7.08333333,8.125 C7.19839266,8.125 7.29166667,8.21827401 7.29166667,8.33333333 C7.29166667,8.44839266 7.19839266,8.54166667 7.08333333,8.54166667"
                id="Shape"></path>
            <line x1="12.9166667" y1="7.91666667" x2="15.4166667" y2="7.91666667" id="Shape"></line>
            <path
                d="M15.4166667,8.54166667 C15.3016073,8.54166667 15.2083333,8.44839266 15.2083333,8.33333333 C15.2083333,8.21827401 15.3016073,8.125 15.4166667,8.125 C15.531726,8.125 15.625,8.21827401 15.625,8.33333333 C15.625,8.44839266 15.531726,8.54166667 15.4166667,8.54166667"
                id="Shape"></path>
            <path
                d="M4.16666667,4.58333333 C4.5601133,4.05873783 5.17758895,3.75 5.83333333,3.75 C6.48907772,3.75 7.10655337,4.05873783 7.5,4.58333333"
                id="Shape"></path>
        </svg>

        <svg width="22px" height="22px" viewBox="0 0 22 22" role="button" class="yes">
            <circle id="Oval" cx="10" cy="10" r="9.58333333"></circle>
            <path
                d="M5.41666667,8.125 C5.53172599,8.125 5.625,8.21827401 5.625,8.33333333 C5.625,8.44839266 5.53172599,8.54166667 5.41666667,8.54166667 C5.30160734,8.54166667 5.20833333,8.44839266 5.20833333,8.33333333 C5.20833333,8.21827401 5.30160734,8.125 5.41666667,8.125"
                id="Shape"></path>
            <path
                d="M14.5833333,8.125 C14.468274,8.125 14.375,8.21827401 14.375,8.33333333 C14.375,8.44839266 14.468274,8.54166667 14.5833333,8.54166667 C14.6983927,8.54166667 14.7916667,8.44839266 14.7916667,8.33333333 C14.7916667,8.21827401 14.6983927,8.125 14.5833333,8.125"
                id="Shape"></path>
            <path
                d="M13.2275,12.9166657 C13.4853075,12.9162808 13.7287776,13.035241 13.8869095,13.2388563 C14.0450415,13.4424715 14.1000278,13.7078123 14.0358333,13.9575 C13.562901,15.7999679 11.9021969,17.0882321 10,17.0882321 C8.09780311,17.0882321 6.43709903,15.7999679 5.96416667,13.9575 C5.89997223,13.7078123 5.95495852,13.4424715 6.11309045,13.2388563 C6.27122239,13.035241 6.51469246,12.9162808 6.7725,12.9166657 L13.2275,12.9166657 Z"
                id="Shape"></path>
        </svg>
    </div>


</div>  </div>
</main>
</div>
<footer class="footer">
  <div class="column">
    <div class="logo-footer"></div>
    <p>© <span id="footer-copyright-year">2020</span> Neo4j, Inc.<br>
      <a href="/terms/">Terms</a> | <a href="/privacy-policy/">Privacy </a> | <a href="/sitemap/">Sitemap</a></p>
    <p>Neo4j<sup>®</sup>, Neo Technology<sup>®</sup>, Cypher<sup>®</sup>, Neo4j<sup>®</sup> Bloom<sup>™</sup> and
      Neo4j<sup>®</sup> Aura<sup>™</sup> are registered trademarks
      of Neo4j, Inc. All other marks are owned by their respective companies.</p>
  </div>

  <div class="column">
    <a href="/contact-us?ref=footer">Contact Us →</a>
    <p>US: 1-855-636-4532<br>
      Sweden +46 171 480 113<br>
      UK: +44 20 3868 3223<br>
      France: +33 (0) 8 05 08 03 44<br>
      <!--Germany: +49 (0)89 26204 6300</p>-->
    </p>
  </div>
</footer><script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-quadtree.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-force.v2.min.js"></script>

<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/gram.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/search.js"></script>  </body>
</html>
