<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Graph Model Refactoring :: Neo4j Developer Portal</title>
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article developer">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/developer">
        <svg width="97px" height="36px" viewBox="0 0 97 36" class="logo">
          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g transform="translate(0.000000, 1.000000)" fill-rule="nonzero">
              <g>
                <path
                  d="M28.7331787,15.4086598 C28.7331787,23.4004124 22.3016241,29.8779381 14.3665893,29.8779381 C6.43155452,29.8779381 0,23.4004124 0,15.4086598 C0,7.41690722 6.43155452,0.939375765 14.3665893,0.939375765 C22.3016241,0.932371134 28.7331787,7.41690722 28.7331787,15.4086598"
                  fill="#008CC1"></path>
                <path
                  d="M6.36890951,10.6626804 C6.36890951,11.3006186 5.85382831,11.8193814 5.22041763,11.8193814 C4.58700696,11.8193814 4.07192575,11.3006186 4.07192575,10.6626804 C4.07192575,10.0247423 4.58700696,9.50597938 5.22041763,9.50597938 C5.86078886,9.50597938 6.36890951,10.0247423 6.36890951,10.6626804"
                  fill="#FFFFFF"></path>
                <path
                  d="M6.5638051,13.8383505 C6.5638051,14.4762887 6.0487239,14.9950515 5.41531323,14.9950515 C4.78190255,14.9950515 4.26682135,14.4762887 4.26682135,13.8383505 C4.26682135,13.2004124 4.78190255,12.6816495 5.41531323,12.6816495 C6.0487239,12.6816495 6.5638051,13.1934021 6.5638051,13.8383505"
                  fill="#FFFFFF"></path>
                <path
                  d="M7.26682135,17.203299 C7.26682135,17.8412371 6.75174014,18.36 6.11832947,18.36 C5.48491879,18.36 4.96983759,17.8412371 4.96983759,17.203299 C4.96983759,16.5653608 5.48491879,16.0465979 6.11832947,16.0465979 C6.75174014,16.0395876 7.26682135,16.5583505 7.26682135,17.203299"
                  fill="#FFFFFF"></path>
                <path
                  d="M8.83990719,20.217732 C8.83990719,20.8556701 8.32482599,21.374433 7.69141531,21.374433 C7.05800464,21.374433 6.54292343,20.8556701 6.54292343,20.217732 C6.54292343,19.5797938 7.05800464,19.0610309 7.69141531,19.0610309 C8.32482599,19.0540206 8.83990719,19.5727835 8.83990719,20.217732"
                  fill="#FFFFFF"></path>
                <path
                  d="M21.1392111,24.4309278 C21.1392111,25.068866 20.6241299,25.5876289 19.9907193,25.5876289 C19.3573086,25.5876289 18.8422274,25.068866 18.8422274,24.4309278 C18.8422274,23.7929897 19.3573086,23.2742268 19.9907193,23.2742268 C20.6241299,23.2742268 21.1392111,23.7929897 21.1392111,24.4309278"
                  fill="#FFFFFF"></path>
                <path
                  d="M23.2273782,21.942268 C23.2273782,22.5802062 22.712297,23.0989691 22.0788863,23.0989691 C21.4454756,23.0989691 20.9303944,22.5802062 20.9303944,21.942268 C20.9303944,21.3043299 21.4454756,20.785567 22.0788863,20.785567 C22.712297,20.785567 23.2273782,21.3043299 23.2273782,21.942268"
                  fill="#FFFFFF"></path>
                <path
                  d="M17.1716937,4.34639175 C17.1716937,4.9843299 16.6566125,5.50309278 16.0232019,5.50309278 C15.3897912,5.50309278 14.87471,4.9843299 14.87471,4.34639175 C14.87471,3.70845361 15.3897912,3.18969072 16.0232019,3.18969072 C16.6566125,3.18969072 17.1716937,3.70845361 17.1716937,4.34639175"
                  fill="#FFFFFF"></path>
                <path
                  d="M14.1508121,3.28082474 C14.1508121,3.91876289 13.6357309,4.43752577 13.0023202,4.43752577 C12.3689095,4.43752577 11.8538283,3.91876289 11.8538283,3.28082474 C11.8538283,2.6428866 12.3689095,2.12412371 13.0023202,2.12412371 C13.6357309,2.12412371 14.1508121,2.6428866 14.1508121,3.28082474"
                  fill="#FFFFFF"></path>
                <ellipse id="Oval" stroke="#FFFFFF" fill="#66B245" cx="22.2946636" cy="11.9595876" rx="7.65661253"
                  ry="7.71134021"></ellipse>
                <ellipse id="Oval" stroke="#FFFFFF" fill="#66B245" cx="11.8051044" cy="27.6837113" rx="6.26450116"
                  ry="6.30927835"></ellipse>
                <ellipse id="Oval" stroke="#FFFFFF" fill="#66B245" cx="6.64733179" cy="4.20618557" rx="4.17633411"
                  ry="4.20618557"></ellipse>
              </g>
              <g id="neo4j" transform="translate(33.000000, 1.000000)" fill="#000000">
                <path
                  d="M0,4.87252125 L1.39130435,4.87252125 L1.39130435,7.6203966 C2.05913043,5.9490085 3.45043478,4.64589235 6.28869565,4.64589235 C9.51652174,4.64589235 11.6869565,6.85552408 11.6869565,10.3399433 L11.6869565,19.1501416 L10.2956522,19.1501416 L10.2956522,10.6232295 C10.2956522,7.76203966 8.57043478,5.97733711 5.9826087,5.97733711 C3.17217391,5.97733711 1.39130435,8.18696884 1.39130435,11.4730878 L1.39130435,19.1501416 L0,19.1501416 L0,4.87252125 Z">
                </path>
                <path
                  d="M14.1634783,12.0396601 C14.1634783,7.59206799 17.1408696,4.5325779 21.0086957,4.5325779 C24.8208696,4.5325779 27.52,7.73371105 27.52,11.6430595 C27.52,11.6430595 27.52,12.0679887 27.4921739,12.3512748 L15.5269565,12.3512748 C15.6104348,15.7790368 17.8643478,18.2152975 21.0643478,18.2152975 C23.68,18.2152975 25.4886957,17.082153 26.3234783,16.0056657 L26.3234783,17.6770538 C25.0156522,18.8668555 23.4295652,19.5467422 21.0643478,19.5467422 C17.0295652,19.5467422 14.1634783,16.5439093 14.1634783,12.1246459 L14.1634783,12.0396601 Z M26.0452174,11.0764873 C26.0173913,8.15864023 23.7913043,5.86402266 21.0086957,5.86402266 C18.0869565,5.86402266 15.693913,8.15864023 15.5826087,11.0764873 L26.0452174,11.0764873 Z">
                </path>
                <path
                  d="M37.0643478,4.50424929 C41.1826087,4.50424929 44.4382609,7.70538244 44.4382609,12.0113314 C44.4382609,16.3172805 41.1826087,19.5184136 37.0643478,19.5184136 C32.946087,19.5184136 29.6904348,16.3172805 29.6904348,12.0113314 C29.6904348,7.70538244 32.946087,4.50424929 37.0643478,4.50424929 Z M37.0643478,18.1869688 C40.4869565,18.1869688 43.0469565,15.5240793 43.0469565,12.0113314 C43.0469565,8.49858357 40.4869565,5.83569405 37.0643478,5.83569405 C33.6417391,5.83569405 31.0817391,8.49858357 31.0817391,12.0113314 C31.0817391,15.5240793 33.6417391,18.1869688 37.0643478,18.1869688 Z">
                </path>
                <polygon
                  points="51.7843478 4.87252125 53.3426087 4.87252125 47.3878261 17.7903683 56.0417391 17.7903683 56.0417391 13.1161473 57.4886957 13.1161473 57.4886957 24.6175637 56.0417391 24.6175637 56.0417391 19.1501416 45.1895652 19.1501416">
                </polygon>
                <path
                  d="M62.2469565,4.87252125 L63.6382609,4.87252125 L63.6382609,21.1331445 C63.6382609,24.3342776 61.8295652,24.9858357 60.0765217,24.9858357 C59.7426087,24.9858357 59.3808696,24.9575071 59.1582609,24.9008499 L59.1582609,23.5694051 C59.4921739,23.6260623 59.8817391,23.6543909 60.2156522,23.6543909 C61.6347826,23.6543909 62.2469565,22.9461756 62.2469565,21.1331445 L62.2469565,4.87252125 Z M61.9408696,1.04815864 C61.9408696,0.45325779 62.413913,0.0283286119 62.9426087,0.0283286119 C63.4713043,0.0283286119 63.9443478,0.45325779 63.9443478,1.04815864 C63.9443478,1.61473088 63.4713043,2.03966006 62.9426087,2.03966006 C62.413913,2.03966006 61.9408696,1.61473088 61.9408696,1.04815864 Z">
                </path>
              </g>
            </g>
          </g>
        </svg>

        <svg width="131px" height="34px" viewBox="0 0 131 34">
          <path
            d="M11.112,20.364 C13.996,20.364 16.124,18.768 16.712,17.06 L16.712,20 L18.112,20 L18.112,0.484 L16.712,0.484 L16.712,8.828 C16.124,7.12 13.996,5.524 11.112,5.524 C7.164,5.524 4,8.688 4,12.944 C4,17.2 7.136,20.364 11.112,20.364 Z M11.112,19.048 C7.864,19.048 5.4,16.416 5.4,12.944 C5.4,9.5 7.864,6.84 11.112,6.84 C14.388,6.84 16.88,9.388 16.88,12.944 C16.88,16.5 14.388,19.048 11.112,19.048 Z M26.876,20.336 C28.864,20.336 30.824,19.692 32.42,17.872 L31.496,16.976 C30.292,18.236 28.92,19.02 26.876,19.02 C23.656,19.02 21.388,16.668 21.304,13.28 L33.344,13.28 C33.372,13 33.372,12.58 33.372,12.58 C33.372,8.688 30.656,5.524 26.82,5.524 C22.928,5.524 19.932,8.576 19.932,12.972 L19.932,13.056 C19.932,17.368 22.844,20.336 26.876,20.336 Z M31.916,12.02 L21.36,12.02 C21.472,9.108 23.852,6.84 26.82,6.84 C29.648,6.84 31.888,9.136 31.916,12.02 Z M40.624,20.728 L47.204,5.888 L45.692,5.888 L40.624,17.452 L35.612,5.888 L34.1,5.888 L40.624,20.728 Z M54.904,20.336 C56.892,20.336 58.852,19.692 60.448,17.872 L59.524,16.976 C58.32,18.236 56.948,19.02 54.904,19.02 C51.684,19.02 49.416,16.668 49.332,13.28 L61.372,13.28 C61.4,13 61.4,12.58 61.4,12.58 C61.4,8.688 58.684,5.524 54.848,5.524 C50.956,5.524 47.96,8.576 47.96,12.972 L47.96,13.056 C47.96,17.368 50.872,20.336 54.904,20.336 Z M59.944,12.02 L49.388,12.02 C49.5,9.108 51.88,6.84 54.848,6.84 C57.676,6.84 59.916,9.136 59.944,12.02 Z M67.672,20.364 C68.092,20.364 68.484,20.308 68.848,20.224 L68.848,18.936 C68.484,19.02 68.092,19.048 67.672,19.048 C66.188,19.048 65.572,18.208 65.572,16.36 L65.572,0.484 L64.172,0.484 L64.172,16.444 C64.172,19.692 65.964,20.364 67.672,20.364 Z M77.22,20.364 C81.364,20.364 84.64,17.2 84.64,12.944 C84.64,8.688 81.364,5.524 77.22,5.524 C73.076,5.524 69.8,8.688 69.8,12.944 C69.8,17.2 73.076,20.364 77.22,20.364 Z M77.22,19.048 C73.776,19.048 71.2,16.416 71.2,12.944 C71.2,9.472 73.776,6.84 77.22,6.84 C80.664,6.84 83.24,9.472 83.24,12.944 C83.24,16.416 80.664,19.048 77.22,19.048 Z M88.812,25.404 L88.812,17.06 C89.4,18.768 91.528,20.364 94.412,20.364 C98.36,20.364 101.524,17.2 101.524,12.944 C101.524,8.688 98.388,5.524 94.412,5.524 C91.528,5.524 89.4,7.12 88.812,8.828 L88.812,5.888 L87.412,5.888 L87.412,25.404 L88.812,25.404 Z M94.412,19.048 C91.136,19.048 88.644,16.5 88.644,12.944 C88.644,9.388 91.136,6.84 94.412,6.84 C97.66,6.84 100.124,9.472 100.124,12.944 C100.124,16.388 97.66,19.048 94.412,19.048 Z M110.652,20.336 C112.64,20.336 114.6,19.692 116.196,17.872 L115.272,16.976 C114.068,18.236 112.696,19.02 110.652,19.02 C107.432,19.02 105.164,16.668 105.08,13.28 L117.12,13.28 C117.148,13 117.148,12.58 117.148,12.58 C117.148,8.688 114.432,5.524 110.596,5.524 C106.704,5.524 103.708,8.576 103.708,12.972 L103.708,13.056 C103.708,17.368 106.62,20.336 110.652,20.336 Z M115.692,12.02 L105.136,12.02 C105.248,9.108 107.628,6.84 110.596,6.84 C113.424,6.84 115.664,9.136 115.692,12.02 Z M121.292,20 L121.292,12.272 C121.292,9.472 122.776,7.092 125.856,7.092 C126.192,7.092 126.584,7.12 126.752,7.148 L126.752,5.692 C126.556,5.664 126.276,5.664 126.08,5.664 C123.308,5.664 121.88,7.008 121.292,8.716 L121.292,5.888 L119.892,5.888 L119.892,20 L121.292,20 Z"
            id="developer"></path>
        </svg>
              </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <div class="navbar-item is-hoverable developer">
          <a class="navbar-link" href="/developer">Developer Guides</a>
        </div>
        <div class="navbar-item has-dropdown is-hoverable docs">
          <a class="navbar-link" href="/docs">Docs</a>
          <div class="navbar-dropdown">
            <div class="navbar-item project" href="">
              <a class="project-name" href="">Operations Manual</a>

              <ul class="project-links">
                <li><a href="" class="project-link">Migration Guide</a></li>
                <li><a href="" class="project-link">Status Codes</a></li>
              </ul>
            </div>
            <div class="navbar-item project" href="">
              <a class="project-name" href="">Cypher Manual</a>

              <ul class="project-links">
                <li><a href="" class="project-link">Cyper Refcard</a></li>
              </ul>
            </div>
            <div class="navbar-item project" href="">
              <a class="project-name" href="">Driver Manual</a>

              <ul class="project-links">
                <li><a href="" class="project-link">Java</a></li>
                <li><a href="" class="project-link">JavaScript</a></li>
                <li><a href="" class="project-link">.NET</a></li>
                <li><a href="" class="project-link">Python</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable labs">
          <a class="navbar-link" href="/labs">Labs</a>
          <div class="navbar-dropdown">
            <div class="navbar-item project">
              <a class="project-name" href="/labs/apoc">APOC</a>
              <p class="project-description">A library of procedures and functions for interacting with Neo4j</p>

              <ul class="project-links">
                <li><a href="/labs/apoc/4.0" class="project-link">Documentation</a></li>
                <li><a href="/labs/apoc/" class="project-link">Developer Guide</a></li>
              </ul>
            </div>
            <div class="navbar-item project">
              <a class="project-name" href="/labs/streams">Neo4j Streams</a>
              <p class="project-description">Integration for Neo4j &amp; Kafka</p>

              <ul class="project-links">
                <li><a href="/labs/streams/4.0" class="project-link">Documentation</a></li>
                <li><a href="/labs/streams" class="project-link">Developer Guide</a></li>
              </ul>
            </div>
            <div class="navbar-item project">
              <a class="project-name" href="/labs/neosemantics">neosemantics</a>
              <p class="project-description">An RDF Toolkit for Neo4j</p>

              <ul class="project-links">
                <li><a href="/labs/neosemantics/4.0" class="project-link">Documentation</a></li>
                <li><a href="/labs/neosemantics" class="project-link">Developer Guide</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="navbar-item">
          <svg width="23px" height="23px" viewBox="0 0 23 23" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="fill-current float-right">
            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round">
              <g transform="translate(-2.000000, -2.000000)" stroke="#a0aec0" stroke-width="1.5">
                    <circle id="Oval" transform="translate(11.389364, 11.388564) rotate(-23.025000) translate(-11.389364, -11.388564) " cx="11.3893642" cy="11.3885639" r="8.056"></circle>
                    <path d="M17.0853333,17.0844444 L23.3333333,23.3333333" id="Shape"></path>
              </g>
            </g>
          </svg>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="developer" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../">Developer Guides</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Graph Platform</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../graph-platform/">Graph Platform Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../neo4j-desktop/">Neo4j Desktop Intro</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../neo4j-browser/">Neo4j Browser Intro</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../neo4j-bloom/">Neo4j Bloom Intro</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../neo4j-etl/">How-To: Neo4j ETL Tool</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../neo4j-apoc/">Neo4j APOC Library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../graph-algorithms/">Neo4j Graph Algorithms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../graphql/">Neo4j &amp; GraphQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../neo4j-nlp/">Neo4j Natural Language Processing (NLP)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Cypher Query Language</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cypher-query-language.adoc">Cypher Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cypher-basics-i/">Cypher Basics I</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cypher-basics-ii/">Cypher Basics II</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../filtering-query-results/">Filtering Query Results</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sub-queries/">Sub Queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../aggregation-returns-functions/">Aggregation, Returns, &amp; Functions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cypher-style-guide/">Cypher Style Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guide-sql-to-cypher/">From SQL to Cypher</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../procedures-functions/">User Defined Procedures &amp; Functions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dates-datetimes-durations/">Tutorial: Dates, Datetimes, and Durations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../guide-build-a-recommendation-engine/">Tutorial: Build a Recommendation Engine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cypher-resources/">Cypher Resources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Graph Data Modeling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Graph Modeling Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Graph Modeling Guidelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Modeling: RDBMS to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Modeling Designs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Graph Modeling Tips</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Tutorial: Refactoring a graph model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Interactive Graph Models</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Data Import</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Import Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Importing CSV</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Importing API Data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Import: RDBMS to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Example: Northwind Dataset</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">How-To: Desktop CSV Import</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Example Datasets</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Graph Visualization</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Visualization Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Visualization Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Other Visualizations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Drivers &amp; Language Guides</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Drivers Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Java</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Java Driver Spring Boot Starter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Neo4j Object Graph Mapper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Spring Data Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Spring Data Neo4j RX</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Procedures and Functions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Third-party libraries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">.NET</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">JavaScript</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Python</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Go</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Ruby</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">PHP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Erlang &amp; Elixir</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Perl</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Tools &amp; Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Integrations Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Apache Spark</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Elastic-Search</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">MongoDB</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Cassandra</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Aura DBaaS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Aura DBaaS Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Connect from Neo4j Desktop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Connect from Cypher Shell</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Connect from your application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Data Import with Neo4j Aura</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Deploying a GRANDstack application to Aura</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Bloom Visualization with Aura</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Monitoring</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Graph Apps</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Graph Apps Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Building Graph Apps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Administration Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Tutorial: Managing Multiple Databases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Tutorial: Multi Tenancy Worked Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Sharding Graphs with Fabric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Clustering Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Performance Tuning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Docker &amp; Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">How-To: Run Neo4j in Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Startups: Free Neo4j Enterprise</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Online Course: Neo4j Administration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Neo4j in the Cloud</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Cloud Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Orchestration Tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Documentation &amp; Resources</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Resource Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Learn through GraphAcademy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Tutorial: Create Custom Browser Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">How-To: Build with Ruby &amp; Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Available Neo4j Browser Guides</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Neo4j Documentation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text nav-item-toggle">Contributing to Neo4j</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Contributing Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Contributor License Agreement</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Code Contributions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#xxx">Help on Community Forums</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text nav-item-toggle">xref:xxx[Speaker Program: Share your Story</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../get-started/">Getting Started with Neo4j</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-started/">Getting Started with Neo4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-started/graph-database/">What is a Graph Database?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#intro-videos.adoc">Intro to Graph DBs Video Series</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-started/graph-db-vs-rdbms/">Concepts: RDBMS to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-started/graph-db-vs-nosql/">Concepts: NoSQL to Graph</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#getting-started-resources.adoc">Getting Started Resources</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../">Developer Guides</a></li>
    <li><a href="./">Graph Model Refactoring</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/adam/projects/docs/asciidoc/developer/modules/ROOT/pages/graph-model-refactoring.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Graph Model Refactoring</h1>
<div id="toc" class="toc">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#airports-dataset">Airports dataset</a></li>
<li><a href="#property-to-boolean">Convert property to boolean</a></li>
<li><a href="#create-node-from-relationship">Create node from relationship</a></li>
<li><a href="#create-node-from-property">Create node from property</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<div class="title">Goals</div>
<blockquote>
Building on the Cypher Basics guides, this guide provides a worked example of changing a graph model.
Upon finishing this guide, you should be able to evolve your graph model based on changing requirements.
</blockquote>
</div>
<div class="quoteblock abstract">
<div class="title">Prerequisites</div>
<blockquote>
You should be familiar with <a href="/developer/get-started/graph-database">graph database</a> concepts and the <a href="/developer/get-started/graph-database#property-graph">property graph model</a>.
This guide is a continuation of the concepts discussed in the previous Cypher sections.
You should be familiar with <a href="/developer/cypher/cypher-query-language">MATCH</a>, <a href="/developer/cypher/cypher-basics-ii/">Create/Update/Delete</a>, and <a href="/developer/cypher/filtering-query-results/">Filtering</a> concepts before walking through this guide.
</blockquote>
</div>
<div class="paragraph expertise">
<p>Intermediate</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="airports-dataset"><a class="anchor" href="#airports-dataset"></a>Airports dataset</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide we&#8217;re going to use an airports dataset that contains connections between US airports in January 2008.
We have the data in a CSV file, and this is the graph model that we&#8217;re going to import it into:</p>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/initial_model.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/initial_model.png" alt="initial model"></a>
</div>
</div>
<div class="paragraph">
<p>Before we import any data, we&#8217;re going to create a unique constraint on the <code>Airport</code> label and <code>code</code> property to ensure that we don&#8217;t accidentally import duplicate airports.
The following query creates this constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CREATE CONSTRAINT ON (airport:Airport)
ASSERT airport.code IS UNIQUE</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 rows available after 86 ms, consumed after another 0 ms. Added 1 constraints</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And the following query loads the data from a CSV file using the <code>LOAD CSV</code> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">LOAD CSV WITH HEADERS FROM "https://raw.githubusercontent.com/neo4j-contrib/training/master/modeling/data/flights_1k.csv" AS row
MERGE (origin:Airport {code: row.Origin})
MERGE (destination:Airport {code: row.Dest})
MERGE (origin)-[connection:CONNECTED_TO {
  airline: row.UniqueCarrier,
  flightNumber: row.FlightNum,
  date: date({year: toInteger(row.Year), month: toInteger(row.Month), day: toInteger(row.DayofMonth)}),
  cancelled: row.Cancelled,
  diverted: row.Diverted}]-&gt;(destination)
ON CREATE SET connection.departure = localtime(apoc.text.lpad(row.CRSDepTime, 4, "0")),
              connection.arrival = localtime(apoc.text.lpad(row.CRSArrTime, 4, "0"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates a node with an <code>Airport</code> label with a <code>code</code> property that has a value from the <code>Origin</code> column in the CSV file</p>
</li>
<li>
<p>Creates a node with an <code>Airport</code> label with a <code>code</code> property that has a value from the <code>Dest</code> column in the CSV file</p>
</li>
<li>
<p>Creates a relationship of type <code>CONNECTED_TO</code> with several properties based on columns in the CSV file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we run this query we&#8217;ll see the following output:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Added 62 labels, created 62 nodes, set 7062 properties, created 1000 relationships, completed after 376 ms.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This model is a good starter one, but there are some improvements that we can make.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="property-to-boolean"><a class="anchor" href="#property-to-boolean"></a>Convert property to boolean</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>diverted</code> and <code>cancelled</code> properties on the <code>CONNECTED_TO</code> relationships contain string values of <code>1</code> and <code>0</code>.
Since these values are representing booleans, we can use the <a href="https://neo4j.com/docs/labs/apoc/current/graph-updates/graph-refactoring/normalize-boolean/" target="_blank" rel="noopener"><code>apoc.refactor.normalizeAsBoolean</code></a> procedure to convert the values from strings to booleans.</p>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/boolean_refactoring.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/boolean_refactoring.png" alt="boolean refactoring"></a>
</div>
</div>
<div class="paragraph">
<p>The following query does the conversion for the <code>diverted</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH (:Airport)-[connectedTo:CONNECTED_TO]-&gt;(:Airport)
CALL apoc.refactor.normalizeAsBoolean(connectedTo, "diverted", ["1"], ["0"])
RETURN count(*)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">count(*)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And the following query does the conversion for the <code>cancelled</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH (origin:Airport)-[connectedTo:CONNECTED_TO]-&gt;(departure)
CALL apoc.refactor.normalizeAsBoolean(connectedTo, "cancelled", ["1"], ["0"])
RETURN count(*)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">count(*)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If we have a lot of relationships to update, we may get an OutOfMemory exception if we try to refactor them all in one transaction.
We can therefore process them in batches using the <a href="https://neo4j.com/docs/labs/apoc/current/graph-updates/periodic-execution/#commit-batching" target="_blank" rel="noopener"><code>apoc.periodic.iterate</code></a> procedure.
The following query does this for the <code>cancelled</code> and <code>reverted</code> properties in the same query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">UNWIND ["cancelled", "reverted"] AS propertyToDelete
CALL apoc.periodic.iterate(
  "MATCH (:Airport)-[connectedTo:CONNECTED_TO]-&gt;(:Airport) RETURN connectedTo",
  "CALL apoc.refactor.normalizeAsBoolean(connectedTo, $propertyToDelete, ['1'], ['0'])
   RETURN count(*)",
  {params: {propertyToDelete: propertyToDelete}, batchSize: 100})
YIELD batches
RETURN propertyToDelete, batches</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>apoc.periodic.iterate</code> procedure in this query takes in 3 parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An outer Cypher query that finds and returns a stream of <code>CONNECTED_TO</code> relationships to be processed.</p>
</li>
<li>
<p>An inner Cypher query that processes those <code>CONNECTED_TO</code> relationships, converting to boolean any values for the specified property on those relationships. It does this using the <code>apoc.refactor.normalizeAsBoolean</code> procedure, which itself takes in several parameters:</p>
<div class="ulist">
<ul>
<li>
<p>the entity on which the property exists</p>
</li>
<li>
<p>the name of the property to normalize</p>
</li>
<li>
<p>a list of values that should be considered <code>true</code></p>
</li>
<li>
<p>a list of values that should be considered <code>false</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Configuration values for the procedure, including:</p>
<div class="ulist">
<ul>
<li>
<p><code>params</code> - parameters passed into those Cypher queries</p>
</li>
<li>
<p><code>batchSize</code>- controls the number of inner statements that are run within a single transaction</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When we run this query we&#8217;ll see the following output:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Results</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">propertyToDelete</th>
<th class="tableblock halign-left valign-top">batches</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"cancelled"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"reverted"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once we&#8217;ve done this, we can write the following query to return all cancelled connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH (origin:Airport)-[connectedTo:CONNECTED_TO]-&gt;(destination)
WHERE connectedTo.cancelled
RETURN origin.code AS origin,
       destination.code AS destination,
       connectedTo.date AS date,
       connectedTo.departure AS departure,
       connectedTo.arrival AS arrival</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Results</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">origin</th>
<th class="tableblock halign-left valign-top">destination</th>
<th class="tableblock halign-left valign-top">date</th>
<th class="tableblock halign-left valign-top">departure</th>
<th class="tableblock halign-left valign-top">arrival</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LAS"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"OAK"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">07:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">08:30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LAX"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"SFO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">09:05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10:25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LAX"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"OAK"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12:15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LAX"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"SJC"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20:35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"LAX"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"SFO"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16:20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17:40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MDW"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"STL"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11:10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12:15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MDW"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"BDL"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">08:45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11:40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MDW"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"DTW"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">06:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">08:05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MDW"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"STL"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14:45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MDW"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"BNA"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19:25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20:45</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"OAK"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"BUR"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13:10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14:15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"OAK"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"BUR"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2008-01-03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17:05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18:10</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="create-node-from-relationship"><a class="anchor" href="#create-node-from-relationship"></a>Create node from relationship</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next, imagine that we want to write a query that finds a specific flight.
This is quite difficult with our existing model because flights are represented as relationships.
We can evolve our model to create a <code>Flight</code> node from the properties stored on the <code>CONNECTED_TO</code> relationship.</p>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/flight_node.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/flight_node.png" alt="flight node"></a>
</div>
</div>
<div class="paragraph">
<p>The following query does this refactoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CALL apoc.periodic.iterate(
  "MATCH (origin:Airport)-[connected:CONNECTED_TO]-&gt;(destination:Airport) RETURN origin, connected, destination",
  "CREATE (flight:Flight {
     date: connected.date,
     airline: connected.airline,
     number: connected.flightNumber,
     departure: connected.departure,
     arrival: connected.arrival,
     cancelled: connected.cancelled,
     diverted: connected.diverted
   })
   MERGE (origin)&lt;-[:ORIGIN]-(flight)
   MERGE (flight)-[:DESTINATION]-&gt;(destination)
   DELETE connected",
  {batchSize: 100})</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with our previous query, this query uses the <code>apoc.periodic.iterate</code> procedure so that we can do the refactoring in batches rather than within a single transaction.
The procedure takes in 3 parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An outer Cypher query that finds and returns a stream of <code>CONNECTED_TO</code> relationships, and origin and destination airports that need to be processed.</p>
</li>
<li>
<p>An inner Cypher query that processes those entities, creating a node with the label <code>Flight</code> and creating relationships from that node to the origin and destination airports.</p>
</li>
<li>
<p><code>batchSize</code> configuration, which sets to <code>100</code> the number of inner statements that are run within a single transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we execute the query we&#8217;ll see the following output:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Results</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">batches</th>
<th class="tableblock halign-left valign-top">total</th>
<th class="tableblock halign-left valign-top">timeTaken</th>
<th class="tableblock halign-left valign-top">committedOperations</th>
<th class="tableblock halign-left valign-top">failedOperations</th>
<th class="tableblock halign-left valign-top">failedBatches</th>
<th class="tableblock halign-left valign-top">retries</th>
<th class="tableblock halign-left valign-top">errorMessages</th>
<th class="tableblock halign-left valign-top">batch</th>
<th class="tableblock halign-left valign-top">operations</th>
<th class="tableblock halign-left valign-top">wasTerminated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{total: 10, committed: 10, failed: 0, errors: {}}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{total: 1000, committed: 1000, failed: 0, errors: {}}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We can also do this refactoring using the <a href="https://neo4j.com/docs/labs/apoc/current/graph-updates/graph-refactoring/extract-node-from-relationship/" target="_blank" rel="noopener"><code>apoc.refactor.extractNode</code></a> procedure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CALL apoc.periodic.iterate(
  "MATCH (origin:Airport)-[connected:CONNECTED_TO]-&gt;(destination:Airport)
   RETURN origin, connected, destination",
  "CALL apoc.refactor.extractNode([connected], ['Flight'], 'DESTINATION', 'ORIGIN')
   YIELD input, output, error
   RETURN input, output, error",
  {batchSize: 100});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This does the same as the previous query, but the outer Cypher query uses the <code>apoc.refactor.extractNode</code> procedure to create the <code>Flight</code> node and create relationships to origin and destination airports.
If we run this query we&#8217;ll see the following output:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Results</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">batches</th>
<th class="tableblock halign-left valign-top">total</th>
<th class="tableblock halign-left valign-top">timeTaken</th>
<th class="tableblock halign-left valign-top">committedOperations</th>
<th class="tableblock halign-left valign-top">failedOperations</th>
<th class="tableblock halign-left valign-top">failedBatches</th>
<th class="tableblock halign-left valign-top">retries</th>
<th class="tableblock halign-left valign-top">errorMessages</th>
<th class="tableblock halign-left valign-top">batch</th>
<th class="tableblock halign-left valign-top">operations</th>
<th class="tableblock halign-left valign-top">wasTerminated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{total: 10, committed: 10, failed: 0, errors: {}}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{total: 1000, committed: 1000, failed: 0, errors: {}}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="create-node-from-property"><a class="anchor" href="#create-node-from-property"></a>Create node from property</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the moment the airline for our flights is stored in the <code>airline</code> property on <code>Flight</code> nodes.
This means that if we wanted to return a stream of all airlines we&#8217;d need to scan through every flight and check the <code>airline</code> property on each of those flights.</p>
</div>
<div class="paragraph">
<p>We can make it easier, and more efficient, to write this query by creating a node with an <code>Airline</code> label for each airline:</p>
</div>
<div class="imageblock popup-link">
<div class="content">
<a class="image" href="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/airline.png"><img src="//s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/airline.png" alt="airline"></a>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s first create a constraint on the <code>Airline</code> label and <code>name</code> property so that we don&#8217;t create duplicate airline nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CREATE CONSTRAINT ON (airline:Airline)
ASSERT airline.name IS UNIQUE</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 rows available after 107 ms, consumed after another 0 ms. Added 1 constraints</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And now we can execute the following query to do the refactoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CALL apoc.periodic.iterate(
   'MATCH (flight:Flight) RETURN flight',
   'MERGE (airline:Airline {name:flight.airline})
    MERGE (flight)-[:AIRLINE]-&gt;(airline)
    REMOVE flight.airline',
   {batchSize:10000, iterateList:true, parallel:false}
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again we&#8217;re using the <code>apoc.periodic.iterate</code> procedure, with the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An outer Cypher statement that returns a stream of <code>Flight</code> nodes to be processed</p>
</li>
<li>
<p>An inner Cypher statementthat processes these flight nodes, creating <code>Airline</code> nodes based on flights' <code>airline</code> property and created an <code>AIRLINE</code> relationship from the <code>Flight</code> to the <code>Airline</code> node. We then remove the <code>airline</code> property from the <code>Flight</code> node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we run this query we&#8217;ll see the following output:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Results</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">batches</th>
<th class="tableblock halign-left valign-top">total</th>
<th class="tableblock halign-left valign-top">timeTaken</th>
<th class="tableblock halign-left valign-top">committedOperations</th>
<th class="tableblock halign-left valign-top">failedOperations</th>
<th class="tableblock halign-left valign-top">failedBatches</th>
<th class="tableblock halign-left valign-top">retries</th>
<th class="tableblock halign-left valign-top">errorMessages</th>
<th class="tableblock halign-left valign-top">batch</th>
<th class="tableblock halign-left valign-top">operations</th>
<th class="tableblock halign-left valign-top">wasTerminated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{total: 1, committed: 1, failed: 0, errors: {}}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{total: 1000, committed: 1000, failed: 0, errors: {}}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We can then write the following query to find the airlines and number of flights involving each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">MATCH (airline:Airline)&lt;-[:AIRLINE]-(:Flight)
RETURN airline.name AS airline, count(*) AS numberOfFlights</code></pre>
</div>
</div>
<div class="paragraph">
<p>This does the same as the previous query, but the outer Cypher query uses the <code>apoc.refactor.extractNode</code> procedure to create the <code>Flight</code> node and create relationships to origin and destination airports.
If we run this query we&#8217;ll see the following output:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Results</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">airline</th>
<th class="tableblock halign-left valign-top">numberOfFlights</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"WN"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="cypher-resources"><a class="anchor" href="#cypher-resources"></a>Resources</h3>
<div class="paragraph">
<p>This guide has shown how to refactor a graph model, with help from procedures in the APOC Library.
Below are some resources for learning more about refactoring in Neo4j:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://neo4j.com/developer/neo4j-apoc/" target="_blank" rel="noopener">APOC Library</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="https://neo4j.com/docs/labs/apoc/current/graph-updates/graph-refactoring/" target="_blank" rel="noopener">Graph Refactoring Procedures</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>We need a generic footer here...</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
